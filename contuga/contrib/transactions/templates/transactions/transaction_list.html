{% extends "base/base.html" %}
{% load i18n static widget_tweaks urls %}

{% block title %}{% trans "Transactions" %}{% endblock %}

{% block content %}
<main class="container">

  <div class="row">
    <div class="col-12">
      <form id="filterForm" method="GET">
        <div class="row">
          <div class="col-12 col-md-2">
            {% include 'contuga/forms/field.html' with field=filterset.form.type %}
          </div>
          <div class="col-12 col-md-2">
            {% include 'contuga/forms/field.html' with field=filterset.form.account %}
          </div>
          <div class="col-12 col-md-2">
            {% include 'contuga/forms/field.html' with field=filterset.form.category %}
          </div>
          <div class="col-12 col-md-3">
            {% include 'contuga/forms/field.html' with field=filterset.form.created_at|attr:'autocomplete:off' %}
          </div>
          <div class="col-12 col-md-3">
            {% include 'contuga/forms/field.html' with field=filterset.form.updated_at|attr:'autocomplete:off' %}
          </div>
          <div class="col-12 col-md-3">
            {% include 'contuga/forms/field.html' with field=filterset.form.description %}
          </div>
          <div class="col-12 col-md-3">
            {% include 'contuga/forms/field.html' with field=filterset.form.ordering %}
          </div>
          {% with field=filterset.form.amount amount=filterset.form.amount.0.data.subwidgets.0 select=filterset.form.amount.0.data.subwidgets.1 %}
            <div class="col-12 col-md-4">
              <div class="form-group">
                <label for="{{ field.auto_id }}" class="{% if field.errors %} text-danger {% endif %}">
                  {{ field.label }}{% if field.field.required or required %} &#42;{% endif %}
                </label>
                <div class="input-group">
                  <input type="{{ amount.type }}" name="{{ amount.name }}" class="form-control" id="{{ amount.attrs.id }}" value="{{ amount.value }}"/>
                  <select name="{{ select.name }}" id="{{ select.attrs.id }}" class="selectpicker form-control">
                    {% for option in select.optgroups %}
                      <option value="{{ option.1.0.value }}" {% if option.1.0.selected %} selected {% endif %}>{% trans option.1.0.label %}</option>
                    {% endfor %}
                  </select>
                </div>

                {% if field.errors %}
                  <small class="text-danger">
                    {{ field.errors|striptags }}
                  </small>
                {% endif %}
              </div>
            </div>
          {% endwith %}
          <div class="col-12 col-md-2 d-flex align-items-end mb-3">
            <button type="submit" class="btn btn-primary">
              {% trans "Apply" %}
            </button>
          </div>
        </div>

      </form>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <h1>{% trans "Transactions" %}</h1>
      <div class="table-responsive">
        <table class="table table-striped table-sm" id="transactions">
          <thead>
            <tr>
              <th scope="col">{% trans "Amount" %}</th>
              <th scope="col">{% trans "Type" %}</th>
              <th scope="col">{% trans "Account" %}</th>
              <th scope="col">{% trans "Category" %}</th>
              <th scope="col">{% trans "Created at" %}</th>
              <th scope="col" class="d-none d-md-table-cell">
                {% trans "Description" %}
              </th>
              <th></th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for transaction in object_list %}
            <tr>
              <td>
                <a href="{{ transaction.get_absolute_url }}"
                  class="{% if transaction.is_expenditure %} text-danger {% else %} text-success {% endif %}">
                  {{ transaction.amount|floatformat:2 }}
                </a>
              </td>
              <td>
                <i class="{{ transaction.type_icon_class }}"></i>
              </td>
              <td>
                <a href="{{ transaction.account.get_absolute_url }}">
                  {{ transaction.account.name }}
                </a>
              </td>
              <td>
                <a href="{{ transaction.category.get_absolute_url }}">
                  {{ transaction.category.name }}
                </a>
              </td>
              <td>
                {{ transaction.created_at|date:"SHORT_DATETIME_FORMAT" }}
              </td>
              <td class="d-none d-md-table-cell">
                {{ transaction.description }}
              </td>
              <td>
                <a href="{% url 'transactions:update' transaction.pk %}">
                  <i class="fa fa-pencil"></i>
                </a>
              </td>
              <td>
                <a href="{% url 'transactions:delete' transaction.pk %}">
                  <i class="fa fa-trash"></i>
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if is_paginated %}
      <nav>
        <ul class="pagination">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?{% get_query_parameters page=page_obj.previous_page_number %}">
              {% trans "Previous" %}
            </a>
          </li>
          {% endif %}

          {% for page in paginator.page_range %}
          <li class="page-item {% if page == page_obj.number %} active {% endif %}">
            <a class="page-link" href="?{% get_query_parameters page=page %}">
              {{ page }}
            </a>
          </li>
          {% endfor %}

          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?{% get_query_parameters page=page_obj.next_page_number %">
              {% trans "Next" %}
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}

    </div>
  </div>
</main>
{% endblock %}

{% block js %}
  {{ block.super }}
  <script type="text/javascript">
    jQuery(function($) {
      var today = moment();
      var dateRangePickerConfig = {
        autoUpdateInput: false,
        showDropdowns: true,
        ranges: {
          '{% trans "Today" %}': [today, today],
          '{% trans "Yesterday" %}': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
          '{% trans "Last 7 Days" %}': [moment().subtract(6, 'days'), today],
          '{% trans "Last 30 Days" %}': [moment().subtract(29, 'days'), today],
          '{% trans "This Month" %}': [moment().startOf('month'), moment().endOf('month')],
          '{% trans "Last Month" %}': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        },
        linkedCalendars: false,
        alwaysShowCalendars: true,
        maxDate: today,
        opens: "left",
        locale: {
          format: 'L',
          applyLabel: '{% trans "Apply" %}',
          cancelLabel: '{% trans "Clear" %}',
          fromLabel: '{% trans "From" %}',
          toLabel: '{% trans "To" %}',
          customRangeLabel: '{% trans "Custom" %}',
          daysOfWeek: [
            '{% trans "Su" context "Day of the week" %}',
            '{% trans "Mo" context "Day of the week" %}',
            '{% trans "Tu" context "Day of the week" %}',
            '{% trans "We" context "Day of the week" %}',
            '{% trans "Th" context "Day of the week" %}',
            '{% trans "Fr" context "Day of the week" %}',
            '{% trans "Sa" context "Day of the week" %}'
          ],
          monthNames: [
            '{% trans "January" %}',
            '{% trans "February" %}',
            '{% trans "March" %}',
            '{% trans "April" %}',
            '{% trans "May" %}',
            '{% trans "June" %}',
            '{% trans "July" %}',
            '{% trans "August" %}',
            '{% trans "September" %}',
            '{% trans "October" %}',
            '{% trans "November" %}',
            '{% trans "December" %}'
          ],
          firstDay: 1
        }
      };

      $('#id_created_at, #id_updated_at').on('apply.daterangepicker', function(event, picker) {
        var startDate = picker.startDate.format(dateRangePickerConfig.locale.format);
        var endDate = picker.endDate.format(dateRangePickerConfig.locale.format);
        $(this).val(startDate + ' - ' + endDate);
      });

      $('#id_created_at, #id_updated_at').on('cancel.daterangepicker', function(event, picker) {
        $(this).val('');
      });

      $('#id_created_at').daterangepicker(dateRangePickerConfig);
      $('#id_updated_at').daterangepicker(dateRangePickerConfig);

      $("#filterForm").on('submit', function(event){
        $(this).find(":input").filter(function() {
          return !this.value;
        }).attr("disabled", "disabled");

        return true;
      });
    });
  </script>
{% endblock %}
