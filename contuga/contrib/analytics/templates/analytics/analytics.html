{% extends "base/base.html" %}
{% load i18n %}

{% block content %}
  <main class="analytics-page">
    <header>
      <div class="container">
        <div class="row">
          <div class="col-12">
            <h1>{{ page.title|default:_("Statistics")}}</h1>
            <h2>{{ page.description|default:_("Monthly reports to help you analyze your financial performance.") }}</h2>
          </div>
        </div>
      </div>
    </header>
    <div class="container-fluid" id="chartContainer">

    </div>
  </main>
{% endblock %}

{% block js %}
  <script type="text/javascript">
    var reports = {{ reports | safe }};

    Object.keys(reports).forEach(function(key) {
      var title = '<div class="row"><div class="col"><h2>' + reports[key]["name"] + '</h2></div></div>';

      var barChartId = 'barChart' + key
      var barChart = '<div class="col-md-5"><canvas id="' + barChartId + '"></canvas></div>';

      var lineChartId = 'lineChart' + key
      var lineChart = '<div class="col-md-5"><canvas id="' + lineChartId + '"></canvas></div>';

      var $row = $('<div class="row">').append(barChart, lineChart)
      var $col = $('<div class="col-12 col-md-11 offset-md-1">').append(title, $row)
      var $section = $('<section class="row">').append($col)

      $('#chartContainer').append($section)

      var labels = reports[key]["reports"].map((it) => `${it.month}.${it.year}`);
      var datasets = [
          {
              label: '{% trans "Income" %}',
              data: reports[key]["reports"].map((it) => it.income),
              backgroundColor: '#28a745'
          },
          {
              label: '{% trans "Expenditures" %}',
              data: reports[key]["reports"].map((it) => it.expenditures),
              backgroundColor: '#dc3545'
          }
      ]

      createChart('bar', barChartId, labels, datasets, reports[key]["currency"]);

      var lineDatasets = [
          {
              label: '{% trans "Balance" %}',
              data: reports[key]["reports"].map((it) => it.balance),
              backgroundColor: '#254c7c'
          }
      ]

      createChart('line', lineChartId, labels, lineDatasets, reports[key]["currency"]);
    })

    function createChart(type, element, labels, datasets, currency) {
      var canvas = document.getElementById(element).getContext('2d');
      var myChart = new Chart(canvas, {
        type: type,
        data: {
          labels: labels,
          datasets: datasets,
        },
        options: {
          animation: false,
          scales: {
            yAxes: [{
              ticks: {
                beginAtZero: true
              }
            }]
          },
          tooltips: {
            enabled: true,
            mode: 'single',
            callbacks: {
              label: function(tooltipItems, data) {
                  return `${tooltipItems.yLabel.toLocaleString()} ${currency}`;
              }
            }
          },
        }
      });
    }
  </script>

{% endblock js %}

{% block css %}
  {{ block.super }}
  <style>
    header {
      background: #254c7c url("{{ page.background.url }}") bottom left / cover no-repeat;
    }
  </style>
{% endblock css %}
